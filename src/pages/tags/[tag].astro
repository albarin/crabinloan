---
import { getCollection } from 'astro:content';
import BaseHead from '../../components/BaseHead.astro';
import Footer from '../../components/Footer.astro';
import FormattedDateShort from '../../components/FormattedDateShort.astro';
import Header from '../../components/Header.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../../consts';

export async function getStaticPaths() {
  const allPosts = await getCollection('blog');
  const publishedPosts = allPosts.filter((post) => !post.data.draft);
  const uniqueTags = [...new Set(publishedPosts.map(post => post.data.tags || []).flat())];
  
  return uniqueTags.map((tag) => {
    const filteredPosts = publishedPosts.filter((post) => 
      post.data.tags && post.data.tags.includes(tag)
    ).sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
    
    return {
      params: { tag },
      props: { posts: filteredPosts },
    };
  });
}

const { tag } = Astro.params;
const { posts } = Astro.props;
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead title={`Posts tagged "${tag}" - ${SITE_TITLE}`} description={`All posts tagged with ${tag}`} />
  </head>
  <body>
    <Header />

    <nav role="navigation" class="toc">
      <h2>Posts tagged "#{tag}"</h2>
      <ul class="post-list">
        {
          posts.map((post) => (
            <li class="post-item">
              <span class="post-date"><FormattedDateShort date={post.data.pubDate} /></span>
              <span class="post-separator">-</span>
              <div class="post-content">
                <a href={`/blog/${post.id}/`}>{post.data.title}</a>
                {post.data.tags && post.data.tags.length > 0 && (
                  <span> <span class="post-tag-separator">-</span> {post.data.tags.map(tagName => (
                    <a href={`/tags/${tagName}`} class="tag-link">#{tagName}</a>
                  ))}</span>
                )}
              </div>
            </li>
          ))
        }
      </ul>
      <p><a href="/">‚Üê Back to home</a></p>
    </nav>

    <Footer />
  </body>
</html>